/**
 * @fileoverview Firestore Security Rules for the Wanderly travel booking system.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for private user data
 * (profiles, bookings, reviews), while allowing public read access to listings.
 * Data integrity is maintained by validating key relationships on write operations.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /listings/{listingId}: Stores listing information (tours, hotels, packages).
 * - /listings/{listingId}/availability/{dateDoc}: Stores availability information for a listing, organized by date.
 * - /bookings/{bookingId}: Stores booking information (This could be moved to a subcollection of `/users/{userId}` for enhanced security but is placed here to avoid complex queries across collections)
 * - /users/{userId}/bookings/{bookingId}: Stores booking information related to a specific user.
 * - /listings/{listingId}/reviews/{reviewId}: Stores reviews for a specific listing.
 * - /users/{userId}/reviews/{reviewId}: Stores reviews made by a specific user.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Listings are publicly readable, but write access is restricted to authorized users (currently open, but requires TODO).
 * - User-specific data (bookings, reviews) is nested under the user's document, enabling list operations scoped to the user.
 * - To prevent unauthorized modifications, relational integrity is enforced by validating
 *   user IDs on create operations and enforcing immutability of these IDs on update.
 *
 * Denormalization for Authorization:
 *  None used. All authorization is via path-based matching.
 *
 * Structural Segregation:
 *  User-specific data (bookings, reviews) is nested under the user's document, enabling list operations scoped to the user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile if the userId matches their auth UID.
     * @allow (get, list, update, delete) - A user can read, update, or delete their own profile.
     * @deny (create) - A user cannot create a profile with a userId that does not match their auth UID.
     * @deny - Any other user attempting to access this profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is disallowed for privacy.
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to listings, but restricts write access.
     * @path /listings/{listingId}
     * @allow (get, list) - Any user can read the listing.
     * @deny (create, update, delete) - No user can create, update, or delete a listing without authorization.
     * @principle Public read, owner-only writes (currently writes are disabled but will be configured later).
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.

       match /availability/{dateDoc} {
          allow get, list: if true;
          allow create, update, delete: if false; // TODO: Add authorization for listing availability management.
       }

       match /reviews/{reviewId} {
            allow get, list: if true;
            allow create, update, delete: if false; // TODO: Add authorization for creating listing reviews.
       }
    }



    /**
     * @description Allows users to manage their own bookings and public read access to all bookings.
     * @path /bookings/{bookingId}
     * @allow (get, list) - Any user can read booking data.
     * @deny (create, update, delete) - Only an authorized user can manage booking data.
     * @principle Public read, owner-only writes (currently writes are disabled but will be configured later).
     */
    match /bookings/{bookingId} {
        allow get, list: if true;
        allow create, update, delete: if false; // TODO: Add authorization for listing bookings management.
    }

      /**
       * @description Allows a user to manage their own bookings.
       * @path /users/{userId}/bookings/{bookingId}
       * @allow (create) - A user can create a booking if the userId matches their auth UID.
       * @allow (get, list, update, delete) - A user can read, update, or delete their own bookings.
       * @deny (create) - A user cannot create a booking with a userId that does not match their auth UID.
       *   This prevents users from creating bookings under other user's IDs.
       * @deny - Any other user attempting to access this booking.
       * @principle Enforces document ownership for writes.
       */
      match /users/{userId}/bookings/{bookingId} {
        function isOwner(userId) {
          return request.auth != null && request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }



    /**
     * @description Allows a user to manage their own reviews.
     * @path /users/{userId}/reviews/{reviewId}
     * @allow (create) - A user can create a review if the userId matches their auth UID.
     * @allow (get, list, update, delete) - A user can read, update, or delete their own reviews.
     * @deny (create) - A user cannot create a review with a userId that does not match their auth UID.
     *   This prevents users from creating reviews under other user's IDs.
     * @deny - Any other user attempting to access this review.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/reviews/{reviewId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}